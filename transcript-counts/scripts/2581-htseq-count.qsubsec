section('{PROJECT_ID}_{PROJECT_SLUG}_{SAMPLE}_htseq', description='Perform htseqcount counting for project {PROJECT_ID} sample {SAMPLE}')
options('-R "select[mem>{MAX_MEM}] rusage[mem={MAX_MEM}]" -M {MAX_MEM}')
options('-R "span[hosts=1]" -n{N_CPU}')
options('-q "{QUEUE}"')
outputs('{LOG_DIR}')

# Make sure the input files are present:
require('{BAM_DIR}/{SAMPLE}.bam', 'PATH_READABLE')
require('{GTF_FILE}', 'PATH_READABLE')

# Load the htseq module:
command('module load samtools', name='modload_samtools')
# command('source /nfs/users/nfs_a/ad33/.bash_profiles/conda_setup && conda activate htseq', name='modload_htseq')

# Create the name-sorted BAM file:
command('{SAMTOOLS_EXEC} sort -@ {N_CPU} -n -T {NODE_TMP}/{PROJECT_ID}_{PROJECT_SLUG}_{SAMPLE} -O BAM {BAM_DIR}/{SAMPLE}.bam > {TEMP_DIR}/{SAMPLE}-namesorted.bam', name='namesort_bam')

# Run the counting on the name-sorted BAM file:
command('{HTSEQ_EXEC} --format=bam --order=name --stranded={STRAND_MODE} --type=exon --idattr=gene_id --mode=union {TEMP_DIR}/{SAMPLE}-namesorted.bam {GTF_FILE} | bgzip -c > {COUNT_DIR}/{SAMPLE}-counts.txt.gz', name='htseq_count')

